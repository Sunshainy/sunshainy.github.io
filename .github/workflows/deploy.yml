name: Deploy to GitHub Pages (build -> upload artifact -> deploy)

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-path: build
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Inspect build output
        run: |
          echo "Build folder size and sample listing:"
          du -sh build || true
          echo "Checking for symlinks inside build (if any):"
          find build -type l -print || true
          echo "Top-level files count:"
          ls -la build | wc -l || true
      - name: Prepare Pages artifact (dereference symlinks)
        run: |
          echo "Creating sanitized artifact directory artifact_build..."
          rm -rf artifact_build || true
          mkdir artifact_build
          echo "Copying build contents and dereferencing symlinks (cp -aL build/. artifact_build/)"
          cp -aL build/. artifact_build/ || true
          echo "Sanitized folder size:"
          du -sh artifact_build || true
          echo "Checking for any remaining symlinks in artifact_build:"
          find artifact_build -type l -print || true
          # fail early if artifact too large (>10GB)
          size_kb=$(du -s artifact_build | awk '{print $1}') || true
          limit_kb=$((10 * 1024 * 1024))
          echo "artifact size (KB): $size_kb; limit (KB): $limit_kb"
          if [ "$size_kb" -gt "$limit_kb" ]; then
            echo "Artifact too large for Pages (>$((10)) GB). Aborting."
            exit 1
          fi
          # ensure no symlinks remain after dereference
          if [ -n "$(find artifact_build -type l -print -quit)" ]; then
            echo "Symlinks remain in artifact_build after dereference â€” aborting deployment."
            exit 1
          fi
          echo "Top 20 largest files in artifact_build (for debugging):"
          du -ah artifact_build | sort -hr | head -n 20 || true
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: artifact_build

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
